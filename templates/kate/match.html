{% extends "base.html" %}

{% load staticfiles %}
{% load kate_extras %}


{% block header %}
    <h1 class="tiny-gap"><a href="{% url 'kate:match' match.id %}?switch={{ switch }}">Game</a></h1>

    <div style="display: table; width: 100%">
        <div style="display: table-row;">
            <div style="display: table-cell; width: 60%">
                <h2>{{ match.white_player_name }} : {{ match.black_player_name }}</h2>
            </div>
            <div style="display: table-cell">
                <p style="font-size: 12px; text-align: right;">Created on: {{ match.begin|fmtdate }}</p>
            </div>
        </div>
    </div>
{% endblock %}


{% block nav %}
    <ul>
        <li><a href="{% url 'kate:match' match.id %}?switch={{ switch|invert }}">Switch Board</a></li>

        <li><a href="{% url 'kate:undomove' match.id %}?switch={{ switch }}" onclick="return confirm('Withdraw last move?')">Withdraw Move</a></li>

        <li><a href="{% url 'kate:resume' match.id %}?switch={{ switch }}">Resume</a></li>

        <li><a href="{% url 'kate:settings' match.id %}?switch={{ switch }}">Settings</a></li>

        <li><a href="{% url 'kate:index' %}">Overview</a></li>
    </ul>
{% endblock %}


{% block content %}
    {% if match.white_player_is_human and match.black_player_is_human %}
        <div id="chat">
            {% include "kate/_chat.html" with match=match %}
        </div>
    {% endif %}

    <div id="board-wrapper">
        <div class="tiny-gap">
            <p>msg: {{ msg|safe }} {{ running }}</p>
        </div>

        <div class="tiny-gap" style="display: grid; grid-template-columns: 1fr 1fr; grid-gap: 4px;">
            <p>Score: {{ match.score }}</p>
            <p>Level: {{ match.level|matchlevel }}</p>
        </div>

        <div class="tiny-gap" style="display: grid; grid-template-columns: 1fr 1fr; grid-gap: 4px;">
            <p>Time White: {{ match.white_elapsed_seconds|fmttime }}</p>
            <p>Time Black: {{ match.black_elapsed_seconds|fmttime }}</p>
        </div>

        <table id="board" matchid="{{ match.id }}" movecnt="{{ match.movecnt }}">
            {% for fmtfield in fmtboard %}
                {% with meta=fmtfield|readmeta field=fmtfield|readfield %}
                {% if meta == 'letter1' or meta == 'number1' %}
                    <tr>
                {% endif %}
                    {% if meta == 'letter' or meta == 'letter1' or meta == 'letter10' %}
                        <td class="board-letter">{{ field }}</td>
                    {% else %}
                            {% if meta == 'number1' or meta == 'number10' %}
                                <td class="board-number">{{ field }}</td>
                            {% else %}
                                {% if meta == movesrc or meta == movedst %}
                                    <td id="{{ meta }}" class="hint droppable" value="{{ field }}">
                                {% else %}
                                    <td id="{{ meta }}" class="droppable" value="{{ field }}">
                                {% endif %}
                                {% if field == "blk" %}
                                    <div>&nbsp;</div>
                                {% else %}
                                    <img class="draggable" src="{% static  field|imgsrc %}">
                                {% endif %}
                            {% endif %}
                    {% endif %}
                {% if meta == 'letter10' or meta == 'number10' %}
                    </tr>
                {% endif %}

                {% endwith %}
            {% endfor %}
        </table>

        <div class="tiny-gap"></div>

        <div id="white-pieces" class="promotion invisible">
            <p value="wQu"><img src="{% static 'wQu'|imgsrc %}"></p>
            <p value="wBp"><img src="{% static 'wBp'|imgsrc %}"></p>
            <p value="wKn"><img src="{% static 'wKn'|imgsrc %}"></p>
            <p value="wRk"><img src="{% static 'wRk'|imgsrc %}"></p>
        </div>
        <div id="black-pieces" class="promotion invisible">
            <p value="bQu"><img src="{% static 'bQu'|imgsrc %}"></p>
            <p value="bBp"><img src="{% static 'bBp'|imgsrc %}"></p>
            <p value="bKn"><img src="{% static 'bKn'|imgsrc %}"></p>
            <p value="bRk"><img src="{% static 'bRk'|imgsrc %}"></p>
        </div>

        <form id="move" method="post" action="{% url 'kate:domove' match.id %}?switch={{ switch }}" style="display: none;">
            {% csrf_token %}
            {{ form.as_p }}
            <input type="submit" value="submit" />
        </form>
    </div>

    <div id="minutes">
        {% include "kate/_minutes.html" with match=match %}
    </div>


    {% if debug == 'true' or debug == 't' %}
        <p>{{ debug_data|safe }}</p>
    {% endif %}

    <script>
        $(document).ready(function() {
            performMove();
            drag();
            drop();

            $('.promotion p').click(function(){
                var piece;
                piece = $(this).attr("value");
                $('#prom-piece').val(piece);
                $('#move').submit();
            });

            setInterval(function(){
                var matchid;
                var movecnt;
                var newcomment;
                matchid = $('#board').attr("matchid");
                movecnt = $('#board').attr("movecnt");
                $.get('/kate/fetchmatch', { matchid: matchid, movecnt: movecnt }, function(data){
                    if(data.length > 0){
                        location.reload();
                    }
                });
          {% if match.level == 0 %}
            }, 20000);
          {% else %}
            }, 40000);
          {% endif %}

          {% if match.white_player_human and match.black_player_human %}
            setInterval(function() {
                var matchid;
                matchid = $('#addcomment').attr("matchid");
                $.get('/kate/fetchcomments', { matchid: matchid }, function(data){
                    if(data.length > 0){
                        $('#comments').html(data);
                    }
                });
            }, 23000);
          {% endif %}
        });
    </script>
{% endblock %}
